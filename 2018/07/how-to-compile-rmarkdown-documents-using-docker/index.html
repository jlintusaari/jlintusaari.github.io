<!DOCTYPE html>
<html lang="en">

  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  
  
  <title>How to compile R Markdown documents using Docker</title>
  <meta name="description" content="I do some freelance web programming and got a request from a client to make a new monthly sales report for their web shop. After specifying what should be in it, I thought to myself, “this would be so quick to make with R Markdown and ggplot2… but wait, why not make it with R Markdown and ggplot2?”">
  
    
    <meta name="keywords" content="R, Docker, R Markdown">
  

  <link rel="stylesheet" href="/assets/main.css">
  <link rel="canonical" href="https://jlintusaari.github.io/2018/07/how-to-compile-rmarkdown-documents-using-docker/">
  
  
  <link rel="alternate" type="application/rss+xml" title="Jarno&#39;s blog" href="https://jlintusaari.github.io/feed.xml">

  <!-- Add icon library -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">

  
  <meta name="twitter:card" content="summary">
  <meta name="twitter:site" content="jlintusaari">
  <meta name="twitter:title" content="How to compile R Markdown documents using Docker">
  <meta name="twitter:description" content="I do some freelance web programming and got a request from a client to make a new monthly sales report for their web shop. After specifying what should be in it, I thought to myself, “this would be...">
  
    <meta name="twitter:creator" content="jlintusaari">
  
  
    
      <meta name="twitter:image:src" content="https://jlintusaari.github.io/img/r-docker-report/sales.png">
      
    
  

  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css?family=Bitter:400,400i,700" rel="stylesheet">

  
  <!-- Google Analytics -->
  <script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-121379633-1', 'auto');
    ga('send', 'pageview');

  </script>


</head>


  <body>

    <header class="site-header">

  <div class="wrapper">

    <a class="site-title" href="/">Jarno&#39;s blog</a>

    <nav class="site-nav">
      
        
        <a class="page-link" href="/archives/">Archives</a>
      
        
        <a class="page-link" href="/about/">About</a>
      
    </nav>

  </div>

</header>


    <main class="page-content" aria-label="Content">
      <div class="wrapper">
        <article class="post" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    
      <h1 class="post-title" itemprop="name headline">How to compile R Markdown documents using Docker</h1>
    
    <p class="post-meta"><time datetime="2018-07-18T00:00:00-05:00" itemprop="datePublished">Jul 18, 2018</time> •
  
    
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
        <a href="/categories/r/">R</a>,
      
    
      
    
  
    
    
      
    
      
    
      
        <a href="/categories/docker/">Docker</a>,
      
    
      
    
      
    
      
    
      
    
      
    
      
    
  
    
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
        <a href="/categories/r-markdown/">R Markdown</a>
      
    
  






<span class="posts-some-links">
  <a href="https://twitter.com/jlintusaari?ref_src=twsrc%5Etfw" class="twitter-follow-button"
     data-show-screen-name="false" data-show-count="false">Follow</a>
  <script async src="https://platform.twitter.com/widgets.js" charset="utf-8"></script>
</span>

</p>
  </header>

  <div class="post-content" itemprop="articleBody">
    <p>I do some freelance web programming and got a request from a client to make a new monthly 
sales report for their web shop. 
After specifying what should be in it, I thought to myself, “this would be so quick to make with 
<a href="https://rmarkdown.rstudio.com/">R Markdown</a> and <a href="https://ggplot2.tidyverse.org/"><code class="highlighter-rouge">ggplot2</code></a>… but wait, why not make it with R Markdown and 
<code class="highlighter-rouge">ggplot2</code>?”</p>

<p>This was actually a pefect case for it since it needed to be printable pdf and come out once
a month. So no need for <a href="https://shiny.rstudio.com/">shiny</a> interactivity this time (no pun intended), just a formally looking 
sales report with figures and tables in it. Let’s do it.</p>

<p>The first thing to think about was how to generate the pdf reports in the web server. 
Generating pdf:s with R Markdown requires first of all R, but also <a href="https://www.latex-project.org/">LaTeX</a> to be installed, and as you
might guess, they were not available in the web server.
An easy way to avoid having to install additional packages to a web server itself is to use Docker 
containers that contain the required packages.</p>

<h2 id="using-r-markdown-in-a-docker-container">Using R Markdown in a Docker container</h2>

<p>As mentioned above, using a <a href="https://www.docker.com/">Docker</a> container saves me from having to installing R, LaTeX and other 
dependencies to the server itself. They don’t need to be maintained and I can easily deploy the 
container to any other web server if a need arises.</p>

<p>I’m going to use <code class="highlighter-rouge">rocker/verse</code> image from the <a href="https://github.com/rocker-org/rocker">rocker R images</a> for creating the report.
This image has the R Markdown and LaTeX systems pre-installed for compiling pdf reports.
If you are new to Docker, here is the <a href="https://docs.docker.com/">official documentation</a> of how to get it installed to your system.</p>

<p>Assuming you have Docker installed, let’s pull the <code class="highlighter-rouge">rocker/verse</code> image with R version <code class="highlighter-rouge">3.5.1</code>:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>docker pull rocker/verse:3.5.1
</code></pre></div></div>

<p>First I’m going to test the image to see what R packages I possibly need to add to the image. 
This image has also RStudio pre-installed in it, and it is configured to run the RStudio server by 
default.
So for testing, running the following command will start RStudio in <code class="highlighter-rouge">localhost:8787</code>:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>docker run <span class="nt">--rm</span> <span class="nt">-p</span> 8787:8787 rocker/verse:3.5.1
</code></pre></div></div>

<p>Once you type <code class="highlighter-rouge">localhost:8787</code> to your browser, you will be asked for a username and password, 
which are both <code class="highlighter-rouge">rstudio</code> by default.
To my happy surprise, all the packages that I needed were already installed so I could just 
go ahead running the pdf compilation.</p>

<h3 id="generating-the-pdf-with-docker">Generating the pdf with Docker</h3>

<p>Let’s begin by compiling pdf reports with the <code class="highlighter-rouge">rocker/verse:3.5.1</code> image.
I have provided a <a href="https://github.com/jlintusaari/R-docker-report">git repository</a> that contains example files for creating pdf reports 
with R Markdown and Docker. 
You can clone it to you computer by running</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>git clone https://github.com/jlintusaari/R-docker-report.git
</code></pre></div></div>

<p>The repository contains an <code class="highlighter-rouge">example_report.R</code> that takes as input a csv file and generates a pdf 
report using the <code class="highlighter-rouge">example_report.Rmd</code> template below:</p>

<div class="language-markdown highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">
---</span>
title: "Texas housing sales report"
author: "Matti Meikäläinen"
date: "<span class="sb">`r paste(Sys.Date())`</span>"
<span class="gh">output: pdf_document
---
</span>
<span class="gu">## Number of sales</span>

The following chart shows the number of housing sales in three cities in Texas.
Data is from the <span class="sb">`txhousing`</span> data set provided by the TAMU real estate center.

<span class="p">```</span><span class="nl">{r echo=FALSE, message=FALSE, warning=FALSE}</span><span class="sb">
ggplot(dt, aes(date, sales, color=city)) + geom_point() + geom_smooth()
</span><span class="p">```</span>

</code></pre></div></div>

<p>The generated pdf looks like this:</p>

<p><img src="https://jlintusaari.github.io/img/r-docker-report/sales.png" alt="Screenshot of the example report" /></p>

<p>The example csv data is stored in <code class="highlighter-rouge">data.csv</code> file and was created with the <code class="highlighter-rouge">R/make_csv.R</code> script.
Assuming we are in the folder where the <code class="highlighter-rouge">example_report.R</code> file is located, we run the following 
command to compile the report with Docker:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>docker run <span class="nt">--rm</span> <span class="nt">-v</span> <span class="nv">$PWD</span>:/report <span class="nt">-w</span> /report rocker/verse:3.5.1 <span class="se">\</span>
 Rscript <span class="nt">--vanilla</span> example_report.R data.csv
</code></pre></div></div>

<p>The compilation works, but there are multiple things that could be improved:</p>

<ol>
  <li>The default user in the container is root, causing the generated pdf to be owned by root</li>
  <li>The above command is rather long and requires setting e.g. the working directory with <code class="highlighter-rouge">-w</code></li>
  <li>With my actual report, the latex system was missing some packages that were automatically installed 
but made the pdf compilation slow</li>
</ol>

<p>So let’s create a new Docker image based on <code class="highlighter-rouge">rocker/verse:3.5.1</code> that is better configured for our 
purposes. 
We will do this using a <a href="https://docs.docker.com/engine/reference/builder/">Dockerfile</a>.
The following <code class="highlighter-rouge">Dockerfile</code> starts the image creation from the <code class="highlighter-rouge">rocker/verse:3.5.1</code> image and 
adds configurations to address the above issues:</p>

<div class="language-dockerfile highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">FROM</span><span class="s"> rocker/verse:3.5.1</span>

<span class="c"># My sales report required an additional latex package called `eurosym`.</span>
<span class="c"># RUN tlmgr install eurosym</span>

<span class="c"># Set a user and the working directory</span>
<span class="k">USER</span><span class="s"> rstudio</span>
<span class="k">WORKDIR</span><span class="s"> /report</span>

<span class="c"># Set the container to run `Rscript --vanilla ` by default</span>
<span class="k">ENTRYPOINT</span><span class="s"> ["/usr/local/bin/Rscript", "--vanilla"]</span>

<span class="c"># Set the `example_report.R data.csv` as the default script to run with ENTRYPOINT's Rscript</span>
<span class="k">CMD</span><span class="s"> ["example_report.R", "data.csv"]</span>
</code></pre></div></div>

<p>You can find this file from the <code class="highlighter-rouge">docker</code> folder in the <a href="https://github.com/jlintusaari/R-docker-report">git repository</a>.
Now assuming you are in the <code class="highlighter-rouge">docker</code> folder where the <code class="highlighter-rouge">Dockerfile</code> is located, you can create the new image 
with:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>docker build <span class="nt">-t</span> report-maker <span class="nb">.</span>
</code></pre></div></div>

<p>After this we can use the <code class="highlighter-rouge">report-maker</code> image to make the <code class="highlighter-rouge">pdf</code> compilation both faster and more 
convenient.
The following command will create the report 
(remember to remove the root owned <code class="highlighter-rouge">example_report.pdf</code> first if you haven’t):</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>docker run <span class="nt">--rm</span> <span class="nt">-v</span> <span class="nv">$PWD</span>:/report report-maker
</code></pre></div></div>

<p>Of course our <code class="highlighter-rouge">report-maker</code> image can be used to run any kind of R scripts, but the name is 
descriptive for our purpose.</p>

<h2 id="production-use">Production use</h2>

<p>The web application I’m deploying this for is implemented with <a href="https://rubyonrails.org/">Ruby on Rails</a>.
Rails provides an inbuilt task system that can easily access the database of the web-application to 
retrieve relevant data for report creation.</p>

<p>In this particular case the pdf reports need to be generated once a month.
I will thus create a rails task that:</p>

<ol>
  <li>Queries the database and saves the relevant information to a csv file</li>
  <li>Provides the generated csv file to the <code class="highlighter-rouge">report-maker</code></li>
</ol>

<p>After that I setup a <a href="https://en.wikipedia.org/wiki/Cron">cron job</a> that runs the task the first day of every month.
Once generated, the report is downloadable for the client through the web application.</p>


  </div>

  
    <div class="post-comments" itemprop="comment">
      <br>
<hr />

<h1>Comments</h1>

<div id="disqus_thread"></div>
<script>

/**
*  RECOMMENDED CONFIGURATION VARIABLES: EDIT AND UNCOMMENT THE SECTION BELOW TO INSERT DYNAMIC VALUES FROM YOUR PLATFORM OR CMS.
*  LEARN WHY DEFINING THESE VARIABLES IS IMPORTANT: https://disqus.com/admin/universalcode/#configuration-variables
**/

var disqus_config = function () {
this.page.url = "https://jlintusaari.github.io/2018/07/how-to-compile-rmarkdown-documents-using-docker/";  // Replace PAGE_URL with your page's canonical URL variable
this.page.identifier = "/2018/07/how-to-compile-rmarkdown-documents-using-docker"; // Replace PAGE_IDENTIFIER with your page's unique identifier variable
};

(function() { // DON'T EDIT BELOW THIS LINE
var d = document, s = d.createElement('script');
s.src = 'https://jarnosblog.disqus.com/embed.js';
s.setAttribute('data-timestamp', +new Date());
(d.head || d.body).appendChild(s);
})();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>

    </div>
  

</article>

      </div>
    </main>

    <footer class="site-footer">

  <div class="wrapper">

    <p>
      

&copy; Jarno Lintusaari - Powered by <a href="https://jekyllrb.com">Jekyll</a> &amp; <a href="https://github.com/yous/whiteglass">whiteglass</a> - Subscribe via <a href="https://jlintusaari.github.io/feed.xml">RSS</a>

    </p>

  </div>

</footer>


  </body>

</html>
